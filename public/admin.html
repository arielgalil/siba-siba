<!DOCTYPE html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>× ×™×”×•×œ ×©×¨×©×¨×ª ×”×¡×™×‘×•×ª â›“ï¸â€ğŸ’¥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Style for the import container */
      #importContainer {
        transition: max-height 0.5s ease-out, opacity 0.5s ease-out,
          padding 0.5s ease-out, border-width 0.5s ease-out; /* ×”×•×¡×¤× ×• transition ×’× ×œ×¤×“×™× ×’ ×•×œ×’×‘×•×œ */
        max-height: 0;
        opacity: 0;
        overflow: hidden;
        padding-top: 0; /* ××™×¤×•×¡ ×¤×“×™× ×’ ×¢×œ×™×•×Ÿ ×•×ª×—×ª×•×Ÿ */
        padding-bottom: 0;
        border-width: 0; /* ××™×¤×•×¡ ×¨×•×—×‘ ×”×’×‘×•×œ */
      }
      #importContainer.visible {
        max-height: 500px; /* Adjust as needed */
        opacity: 1;
        padding-top: 1rem; /* ×©×—×–×•×¨ ×¢×¨×›×™ p-4 ×©×œ Tailwind */
        padding-bottom: 1rem;
        padding-left: 1rem;
        padding-right: 1rem;
        border-width: 1px; /* ×©×—×–×•×¨ ×¢×¨×š border ×©×œ Tailwind */
      }
      /* Ensure textarea respects dark mode */
      textarea {
        color-scheme: light dark;
      }
    </style>
  </head>
  <body
    class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 p-6 flex flex-col items-center"
  >
    <h1 class="text-3xl font-bold mb-4 text-center">
      × ×™×”×•×œ ×©×¨×©×¨×ª ×”×¡×™×‘×•×ª â›“ï¸â€ğŸ’¥
    </h1>
    <div
      id="status"
      class="mb-4 text-center text-sm text-gray-600 dark:text-gray-400 min-h-[1em]"
    >
      ×˜×•×¢×Ÿ...
    </div>

    <div class="mb-4 flex flex-wrap gap-2 justify-center">
      <button
        id="googleSignInBtn"
        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
      >
        ×”×ª×—×‘×¨ ×‘×’×•×’×œ
      </button>
      <button
        id="newGroupBtn"
        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 hidden"
      >
        â• ×”×•×¡×£ ×§×‘×•×¦×”
      </button>
      <button
        id="deleteGroupBtn"
        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 hidden"
      >
        ğŸ—‘ï¸ ××—×§ ×§×‘×•×¦×”
      </button>
      <button
        id="importBtn"
        class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 hidden"
      >
        ğŸ“œ ×™×™×‘× ×§×‘×•×¦×•×ª
      </button>
    </div>

    <div
      id="importContainer"
      class="w-full max-w-xl p-4 border rounded-lg bg-gray-100 dark:bg-gray-800"
    >
      <h3 class="text-lg font-semibold mb-2">×™×™×‘×•× ×§×‘×•×¦×•×ª ××˜×§×¡×˜</h3>
      <p class="text-sm mb-2 text-gray-600 dark:text-gray-400">
        ××‘× ×”: ×©×•×¨×ª × ×•×©×, ×©×•×¨×ª ×¨××ª ×§×•×©×™ (1-5), ×©×•×¨×•×ª ××©×¤×˜×™× (×¢× '*' ×œ× ×¢×•×œ), ×©×•×¨×”
        ×¨×™×§×” ×‘×™×Ÿ ×§×‘×•×¦×•×ª.
      </p>
      <textarea
        id="importText"
        rows="10"
        class="w-full p-2 border rounded bg-white dark:bg-gray-700 mb-2"
        placeholder="× ×•×©× ×”×§×‘×•×¦×” ×”×¨××©×•× ×”&#10;3&#10;××©×¤×˜ ×&#10;*××©×¤×˜ ×‘ (× ×¢×•×œ)&#10;&#10;× ×•×©× ×”×§×‘×•×¦×” ×”×©× ×™×™×”&#10;1&#10;*××©×¤×˜ ×’ (× ×¢×•×œ)&#10;××©×¤×˜ ×“"
      ></textarea>
      <button
        id="submitImportBtn"
        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
      >
        ×‘×¦×¢ ×™×™×‘×•×
      </button>
      <div
        id="importStatus"
        class="mt-2 text-sm text-gray-600 dark:text-gray-400"
      ></div>
    </div>

    <div class="flex items-center mb-6 space-x-2 space-x-reverse">
      <button
        id="prevBtn"
        class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg disabled:opacity-50"
        disabled
      >
        ×”×§×•×“×
      </button>
      <input
        id="groupInput"
        type="number"
        min="1"
        value="1"
        class="w-16 px-2 py-1 border rounded-lg text-center bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
      />
      <span id="groupCount" class="text-gray-600 dark:text-gray-400">/ 0</span>
      <button
        id="nextBtn"
        class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg disabled:opacity-50"
        disabled
      >
        ×”×‘×
      </button>
    </div>

    <div id="group-container" class="w-full max-w-xl"></div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        onAuthStateChanged,
        GoogleAuthProvider,
        signInWithPopup,
      } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
      import {
        getDatabase,
        ref,
        onValue,
        update,
        set,
        push,
        child,
      } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAGFC_TB8iEMvS2PyxeASj1HH4i66AW4UA",
        authDomain: "trivbio.firebaseapp.com",
        databaseURL: "https://trivbio-default-rtdb.firebaseio.com",
        projectId: "trivbio",
        storageBucket: "trivbio.appspot.com",
        messagingSenderId: "1097087574583",
        appId: "1:1097087574583:web:b36c0441537a1f596215b2",
        measurementId: "G-ZY245YB23E",
      };
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getDatabase(app);
      const groupsRef = ref(db, "collections/groups");

      const statusEl = document.getElementById("status");
      const googleBtn = document.getElementById("googleSignInBtn");
      const newBtn = document.getElementById("newGroupBtn"); // ×”×©× ×”×—×“×© "×”×•×¡×£ ×§×‘×•×¦×”" ×‘-HTML
      const delBtn = document.getElementById("deleteGroupBtn");
      const importBtn = document.getElementById("importBtn");
      const importContainer = document.getElementById("importContainer");
      const importText = document.getElementById("importText");
      const submitImportBtn = document.getElementById("submitImportBtn");
      const importStatusEl = document.getElementById("importStatus");
      const container = document.getElementById("group-container");
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");
      const groupInp = document.getElementById("groupInput");
      const groupCountEl = document.getElementById("groupCount");

      const TOPICS = ["×›×œ×œ×™", "×”×ª×", "×’×•×£ ×”××“×", "××§×•×œ×•×’×™×”", "××¢×‘×“×”"];

      let groups = [];
      let idx = 0;
      let admin = false;
      let edit = false;
      let isAddingNewGroup = false; // *** ×“×’×œ ×—×“×© ×œ×¦×™×•×Ÿ ××¦×‘ ×”×•×¡×¤×” ***
      let newGroupDataBuffer = null; // *** ×××’×¨ ×–×× ×™ ×œ× ×ª×•× ×™ ×§×‘×•×¦×” ×—×“×©×” ***
      let currentAuthUser = null;

      // --- Authentication ---
      signInAnonymously(auth).catch((error) => {
        console.error("Anonymous sign-in failed:", error);
        statusEl.innerText = "×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª ×× ×•× ×™××™×ª.";
      });

      const provider = new GoogleAuthProvider();

      googleBtn.onclick = () =>
        signInWithPopup(auth, provider)
          .then((result) => {})
          .catch(
            (e) => (statusEl.innerText = "×©×’×™××ª ×”×ª×—×‘×¨×•×ª ×’×•×’×œ: " + e.message)
          );

      onAuthStateChanged(auth, (u) => {
        currentAuthUser = u;
        if (u) {
          const isGoogleSignIn = u.providerData.some(
            (p) => p.providerId === "google.com"
          );
          if (isGoogleSignIn) {
            googleBtn.classList.add("hidden");
            statusEl.innerText = `××—×•×‘×¨: ${u.email}`;
            checkAdminStatus(u.uid);
          } else {
            googleBtn.classList.remove("hidden");
            statusEl.innerText = "××—×•×‘×¨ ×× ×•× ×™××™×ª. ×”×ª×—×‘×¨ ×¢× ×’×•×’×œ ×œ× ×™×”×•×œ.";
            admin = false;
            updateAdminUI();
          }
          listenForGroups();
        } else {
          googleBtn.classList.remove("hidden");
          statusEl.innerText = "××™× ×š ××—×•×‘×¨. ×”×ª×—×‘×¨ ×¢× ×’×•×’×œ ×œ× ×™×”×•×œ.";
          admin = false;
          updateAdminUI();
          groups = [];
          idx = 0;
          edit = false; // ×œ×•×•×“× ×©×œ× × ×©××¨×™× ×‘××¦×‘ ×¢×¨×™×›×”
          isAddingNewGroup = false; // ××™×¤×•×¡ ×“×’×œ
          render();
          updateNav();
        }
      });

      function checkAdminStatus(uid) {
        const adminRef = ref(db, `admins/${uid}`);
        onValue(
          adminRef,
          (snapshot) => {
            admin = snapshot.exists() && snapshot.val() === true;
            updateAdminUI();
            if (!admin && statusEl.innerText.startsWith("××—×•×‘×¨:")) {
              statusEl.innerText += " (×œ× ×× ×”×œ)";
            }
          },
          { onlyOnce: true }
        );
      }

      function updateAdminUI() {
        if (admin) {
          newBtn.classList.remove("hidden");
          delBtn.classList.remove("hidden");
          importBtn.classList.remove("hidden");
        } else {
          newBtn.classList.add("hidden");
          delBtn.classList.add("hidden");
          importBtn.classList.add("hidden");
          importContainer.classList.remove("visible");
          edit = false;
          isAddingNewGroup = false; // ××™×¤×•×¡ ×“×’×œ
        }
        // Render ×¨×§ ×× ×œ× ×‘××¦×‘ ×”×•×¡×¤×” ×©×›×‘×¨ ××¨×•× ×“×¨
        if (!isAddingNewGroup) {
          render();
        }
      }

      function listenForGroups() {
        onValue(
          groupsRef,
          (snap) => {
            groups = snap.val() || [];
            if (!groups.length && admin && !isAddingNewGroup) {
              statusEl.innerText = "××™×Ÿ ×§×‘×•×¦×•×ª. ×”×•×¡×£ ×§×‘×•×¦×” ×—×“×©×”.";
            } else if (!groups.length && !admin) {
              statusEl.innerText = "××™×Ÿ ×§×‘×•×¦×•×ª ×œ×”×¦×’×”.";
            } else if (
              groups.length > 0 &&
              statusEl.innerText.startsWith("××™×Ÿ ×§×‘×•×¦×•×ª")
            ) {
              statusEl.innerText = "";
            }

            // ×¢×“×›×•×Ÿ idx ×¨×§ ×× ×”×•× ×œ× ×ª×§×™×Ÿ ××• ×× ×œ× ×‘××¦×‘ ×”×•×¡×¤×”
            if (!isAddingNewGroup && idx >= groups.length) {
              idx = Math.max(0, groups.length - 1);
            }
            // ×¢×“×›×Ÿ × ×™×•×•×˜ ×•×¨×™× ×“×•×¨ ×¨×§ ×× ×œ× ×‘×ª×”×œ×™×š ×”×•×¡×¤×” ×¤×¢×™×œ ×©××©×¤×™×¢ ×¢×œ ×”×ª×¦×•×’×”
            if (!isAddingNewGroup) {
              updateNav();
              render();
            } else {
              // ×× ×× ×—× ×• ×›×Ÿ ×‘××¦×‘ ×”×•×¡×¤×”, ×¨×§ × ×¢×“×›×Ÿ ××ª ×”× ×™×•×•×˜ ×©×™×¨××” ××ª ×”××¦×‘ ×”×—×“×© ×”×¤×•×˜× ×¦×™××œ×™
              updateNav();
            }
          },
          (error) => {
            console.error("Error fetching groups:", error);
            statusEl.innerText = "×©×’×™××” ×‘×§×¨×™××ª × ×ª×•× ×™×.";
          }
        );
      }

      // --- Group Actions ---
      newBtn.onclick = () => {
        // ×›×¤×ª×•×¨ "×”×•×¡×£ ×§×‘×•×¦×”"
        if (!admin) return;

        // *** ×©×™× ×•×™: ×¨×§ ××›×™× ×™× × ×ª×•× ×™× ×•××¦×™×’×™× ×˜×•×¤×¡, ×œ× ×©×•××¨×™× ×¢×“×™×™×Ÿ ***
        newGroupDataBuffer = {
          difficulty: 1,
          topic: "×›×œ×œ×™",
          sentences: [{ text: "", movable: true }], // ××ª×—×™×œ×™× ×¢× ××©×¤×˜ ×¨×™×§ ××—×“
        };
        isAddingNewGroup = true; // ××¦×™×™× ×™× ×©×× ×—× ×• ×‘×ª×”×œ×™×š ×”×•×¡×¤×”
        edit = true; // ×¤×•×ª×—×™× ××ª ××¦×‘ ×”×¢×¨×™×›×”
        // idx ×œ× ××©×ª× ×” ×¢×“×™×™×Ÿ, ×”×•× ×™×•×’×“×¨ ×‘×¢×ª ×”×©××™×¨×”
        statusEl.innerText = '××œ× ×¤×¨×˜×™ ×§×‘×•×¦×” ×—×“×©×” ×•×œ×—×¥ "×©××•×¨ ×•×¡×’×•×¨".';
        render(); // ××¦×™×’×™× ××ª ×˜×•×¤×¡ ×”×¢×¨×™×›×” ×¢× ×”× ×ª×•× ×™× ×”×—×“×©×™×
        updateNav(); // ××¢×“×›× ×™× ××ª ×”× ×™×•×•×˜ (××•×œ×™ × ×¦×˜×¨×š ×œ×”×ª××™× ××ª ×–×”)
      };

      delBtn.onclick = () => {
        if (!admin || groups.length === 0 || isAddingNewGroup) return; // ×œ× × ×™×ª×Ÿ ×œ××—×•×§ ×‘×–××Ÿ ×”×•×¡×¤×”
        if (!confirm(`×œ××—×•×§ ××ª ×§×‘×•×¦×” ${idx + 1} ×œ×¦××™×ª×•×ª?`)) return;

        const newGroupsArray = groups.filter((_, index) => index !== idx);
        set(groupsRef, newGroupsArray)
          .then(() => {
            statusEl.innerText = "×§×‘×•×¦×” × ××—×§×”";
            // ×”-Listener ×™×“××’ ×œ×¢×“×›×•×Ÿ idx, ×¨×™× ×“×•×¨ ×•× ×™×•×•×˜
          })
          .catch((e) => (statusEl.innerText = "×©×’×™××” ×‘××—×™×§×”: " + e.message));
      };

      // --- Import Logic ---
      importBtn.onclick = () => {
        if (!admin) return;
        importContainer.classList.toggle("visible");
        importStatusEl.innerText = "";
        importText.value = "";
        // ×× ×¤×•×ª×—×™× ××ª ×”×™×™×‘×•×, × ×‘×˜×œ ××¦×‘ ×”×•×¡×¤×” ×× ×”×™×” ×¤×¢×™×œ
        if (importContainer.classList.contains("visible") && isAddingNewGroup) {
          isAddingNewGroup = false;
          edit = false;
          newGroupDataBuffer = null;
          render();
          updateNav();
        }
      };

      submitImportBtn.onclick = () => {
        if (!admin) return;
        const text = importText.value.trim();
        if (!text) {
          importStatusEl.innerText = "×ª×™×‘×ª ×”×˜×§×¡×˜ ×¨×™×§×”.";
          return;
        }

        importStatusEl.innerText = "××¢×‘×“ × ×ª×•× ×™×...";
        const parsedGroups = parseImportText(text);
        if (parsedGroups.error) {
          importStatusEl.innerText = `×©×’×™××ª × ×™×ª×•×—: ${parsedGroups.error}`;
          return;
        }

        if (parsedGroups.groups.length === 0) {
          importStatusEl.innerText = "×œ× × ××¦××• ×§×‘×•×¦×•×ª ×ª×§×™× ×•×ª ×‘×˜×§×¡×˜.";
          return;
        }
        importGroupsToFirebase(parsedGroups.groups);
      };

      function parseImportText(text) {
        const blocks = text.split(/\n\s*\n/);
        const newGroups = [];
        let error = null;

        blocks.forEach((block, blockIndex) => {
          if (error) return;
          const lines = block
            .trim()
            .split("\n")
            .map((l) => l.trim())
            .filter((l) => l);

          if (lines.length < 3) {
            if (lines.length > 0) {
              error = `×‘×œ×•×§ ${
                blockIndex + 1
              } ×—×™×™×‘ ×œ×”×›×™×œ × ×•×©×, ×¨××ª ×§×•×©×™ (×©×•×¨×” 2) ×•×œ×¤×—×•×ª ××©×¤×˜ ××—×“ (××©×•×¨×” 3).`;
            } else if (blocks.length === 1) {
              error = `× ×¨××” ×©×”×˜×§×¡×˜ ××™× ×• ××›×™×œ ×§×‘×•×¦×•×ª ×ª×§×™× ×•×ª.`;
            }
            return;
          }

          const topicLine = lines[0];
          const topic = TOPICS.includes(topicLine) ? topicLine : "×›×œ×œ×™";

          let difficulty = 1;
          const difficultyLine = lines[1];
          const parsedDifficulty = parseInt(difficultyLine, 10);
          if (
            !isNaN(parsedDifficulty) &&
            parsedDifficulty >= 1 &&
            parsedDifficulty <= 5
          ) {
            difficulty = parsedDifficulty;
          } else {
            console.warn(
              `Invalid or missing difficulty '${difficultyLine}' in block ${
                blockIndex + 1
              }. Defaulting to 1.`
            );
          }

          const sentences = lines
            .slice(2)
            .map((line) => {
              const isLocked = line.startsWith("*");
              const text = isLocked ? line.substring(1).trim() : line;
              if (!text) return null;
              return { text: text, movable: !isLocked };
            })
            .filter((s) => s !== null);

          if (sentences.length === 0) {
            error = `×‘×§×‘×•×¦×” ×¢× × ×•×©× "${topicLine}" (×‘×œ×•×§ ${
              blockIndex + 1
            }) ×œ× × ××¦××• ××©×¤×˜×™× ×ª×§×™× ×™× ×”×—×œ ××”×©×•×¨×” ×”×©×œ×™×©×™×ª.`;
            return;
          }

          newGroups.push({
            difficulty: difficulty,
            topic: topic,
            sentences: sentences,
          });
        });
        return { groups: newGroups, error: error };
      }

      async function importGroupsToFirebase(parsedGroups) {
        if (!admin) return;
        importStatusEl.innerText = `××™×™×‘× ${parsedGroups.length} ×§×‘×•×¦×•×ª...`;
        try {
          const updatedGroups = [...groups, ...parsedGroups];
          await set(groupsRef, updatedGroups);
          importStatusEl.innerText = `×™×™×‘×•× ${parsedGroups.length} ×§×‘×•×¦×•×ª ×”×•×©×œ× ×‘×”×¦×œ×—×”!`;
          importText.value = "";
          importContainer.classList.remove("visible");
          // ×”-listener ×™×˜×¤×œ ×‘×¢×“×›×•×Ÿ ×”×ª×¦×•×’×”
        } catch (e) {
          console.error("Import error:", e);
          importStatusEl.innerText = "×©×’×™××” ×‘×™×™×‘×•×: " + e.message;
        }
      }

      // --- Rendering Logic ---
      const topicOptionsHTML = TOPICS.map(
        (t) => `<option value="${t}">${t}</option>`
      ).join("");
      const rowHTML = (text, locked) => `
      <div class="sentence-row flex items-center space-x-2 space-x-reverse mb-2">
        <input type="text" value="${text}" class="sentence-input flex-1 p-2 border rounded bg-white dark:bg-gray-700" placeholder="×”×–×Ÿ ××©×¤×˜ ×›××Ÿ" />
        <label class="inline-flex items-center space-x-1 space-x-reverse">
          <input type="checkbox" ${
            locked ? "checked" : ""
          } class="lock-checkbox h-5 w-5" /><span>ğŸ”’</span>
        </label>
        <button type="button" class="removeSentence text-red-500 hover:text-red-700 font-bold">âœ–ï¸</button>
      </div>`;

      function view(g) {
        // ×¤×•× ×§×¦×™×” ×–×• × ×§×¨××ª ×¨×§ ×›×©×× ×—× ×• ×œ× ×‘××¦×‘ ×¢×¨×™×›×”
        const currentIdx = idx; // ×©××™×¨×ª ×”××™× ×“×§×¡ ×”× ×•×›×—×™
        const topicDisplay = g.topic || "×›×œ×œ×™"; // ×”×¦×’ "×›×œ×œ×™" ×× ××™×Ÿ × ×•×©×
        const difficultyDisplay = g.difficulty || "?"; // ×”×¦×’ "?" ×× ××™×Ÿ ×¨××ª ×§×•×©×™
        const title = `${topicDisplay} - ×¨××” ${difficultyDisplay}`;

        return `
    <div class="border rounded-2xl shadow-lg p-4 bg-gray-50 dark:bg-gray-800 relative">
      ${
        admin
          ? `<button data-idx="${currentIdx}" id="editBtn" class="absolute top-2 left-2 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-xl">âœï¸</button>`
          : ""
      }
      <h2 class="text-2xl font-semibold mb-4">${title}</h2>
      <h3 class="text-lg font-semibold mb-2">××©×¤×˜×™×:</h3>
      <ul class="list-decimal list-inside space-y-1">
        ${g.sentences
          .map(
            (s) =>
              `<li>${s.text}${
                !s.movable
                  ? ' <span class="text-sm text-green-600 dark:text-green-400">ğŸ”’</span>'
                  : ""
              }</li>`
          )
          .join("")}
      </ul>
    </div>`;
      }

      function editForm(g) {
        // g ×™×›×•×œ ×œ×”×™×•×ª null ×× isAddingNewGroup=true
        const dataToEdit = isAddingNewGroup ? newGroupDataBuffer : g;
        if (!dataToEdit) {
          console.error("editForm called without data and not in adding mode.");
          return '<p class="text-red-500">×©×’×™××” ×‘×”×¦×’×ª ×˜×•×¤×¡ ×¢×¨×™×›×”.</p>';
        }
        const rows = dataToEdit.sentences
          .map((s) => rowHTML(s.text, !s.movable))
          .join("");
        const currentTopic = dataToEdit.topic || "×›×œ×œ×™";
        const title = isAddingNewGroup
          ? "×”×•×¡×¤×ª ×§×‘×•×¦×” ×—×“×©×”"
          : `×¢×¨×™×›×ª ×§×‘×•×¦×” ${idx + 1}`;
        return `
      <div class="border rounded-2xl shadow-lg p-4 bg-gray-50 dark:bg-gray-800">
        <h2 class="text-2xl font-semibold mb-2">${title}</h2>
        <form id="editForm" class="space-y-3">
          <div class="flex flex-wrap gap-4 items-center mb-4">
              <label class="block">×¨××ª ×§×•×©×™:
                  <input id="diffInput" type="number" value="${
                    dataToEdit.difficulty
                  }" min="1" max="5" class="p-1 border rounded bg-white dark:bg-gray-700 w-16" />
              </label>
              <label class="block">× ×•×©×:
                <select id="topicInput" class="p-1 border rounded bg-white dark:bg-gray-700">
                  ${TOPICS.map(
                    (t) =>
                      `<option value="${t}" ${
                        t === currentTopic ? "selected" : ""
                      }>${t}</option>`
                  ).join("")}
                 </select>
              </label>
          </div>
          <div id="sentences-container">
             <h3 class="text-lg font-semibold mb-2">××©×¤×˜×™×:</h3>
             ${rows}
          </div>
          <button type="button" id="addSentence" class="mt-2 px-3 py-1 bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 rounded">â• ×”×•×¡×£ ××©×¤×˜</button>
          <div class="flex justify-between mt-4">
            <button type="button" id="cancelBtn" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">×‘×™×˜×•×œ</button>
            <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">×©××•×¨ ×•×¡×’×•×¨</button>
          </div>
        </form>
      </div>`;
      }

      function render() {
        if (edit && isAddingNewGroup) {
          // ×× ×‘××¦×‘ ×¢×¨×™×›×” ×•×”×•×¡×¤×”
          container.innerHTML = editForm(null); // ××¦×™×’×™× ×˜×•×¤×¡ ×¨×™×§/×¢× × ×ª×•× ×™ ×‘×¨×™×¨×ª ××—×“×œ
        } else if (edit && admin && groups.length > 0 && idx < groups.length) {
          // ×× ×‘××¦×‘ ×¢×¨×™×›×” ×¨×’×™×œ
          container.innerHTML = editForm(groups[idx]);
        } else if (!edit && groups.length > 0 && idx < groups.length) {
          // ×× ×‘××¦×‘ ×ª×¦×•×’×”
          container.innerHTML = view(groups[idx]);
        } else if (!edit && groups.length === 0 && !isAddingNewGroup) {
          // ×× ××™×Ÿ ×§×‘×•×¦×•×ª ×•×œ× ××•×¡×™×¤×™×
          container.innerHTML = admin
            ? '<p class="text-center text-gray-500 dark:text-gray-400">××™×Ÿ ×§×‘×•×¦×•×ª ×œ×”×¦×’×”. ×”×•×¡×£ ×§×‘×•×¦×” ×—×“×©×” ××• ×™×™×‘× ×§×‘×•×¦×•×ª.</p>'
            : '<p class="text-center text-gray-500 dark:text-gray-400">××™×Ÿ ×§×‘×•×¦×•×ª ×œ×”×¦×’×”.</p>';
        } else if (!edit && !isAddingNewGroup) {
          // ×× ×”-idx ×œ× ×ª×§×™×Ÿ (×™×›×•×œ ×œ×§×¨×•×ª ×¨×’×¢×™×ª ××—×¨×™ ××—×™×§×”)
          console.warn(
            "Render called with invalid index or state, waiting for listener update."
          );
          container.innerHTML =
            '<p class="text-center text-gray-500 dark:text-gray-400">×˜×•×¢×Ÿ...</p>'; // ×××ª×™× ×™× ×œ×¢×“×›×•×Ÿ ××”-listener
        }
        // ×× isAddingNewGroup=true ×•-edit=false (×§×•×¨×” ××—×¨×™ ×‘×™×˜×•×œ), ×”-listener ×™×˜×¤×œ ×‘×¨×™× ×“×•×¨ ×”× ×›×•×Ÿ
      }

      // --- Navigation ---
      function updateNav() {
        const totalGroups = groups.length;
        const displayIdx = isAddingNewGroup ? totalGroups : idx; // ×”××™× ×“×§×¡ ×œ×ª×¦×•×’×” ×‘× ×™×•×•×˜
        const displayTotal = isAddingNewGroup ? totalGroups + 1 : totalGroups; // ×”×¡×”"×› ×œ×ª×¦×•×’×”

        prevBtn.disabled = displayIdx <= 0 || edit; // ×”×©×‘×ª×” ×’× ×‘××¦×‘ ×¢×¨×™×›×”
        nextBtn.disabled = displayIdx >= displayTotal - 1 || edit; // ×”×©×‘×ª×” ×’× ×‘××¦×‘ ×¢×¨×™×›×”
        groupInp.disabled = edit; // ×”×©×‘×ª×” ×’× ×‘××¦×‘ ×¢×¨×™×›×”
        groupInp.value =
          totalGroups === 0 && !isAddingNewGroup ? 0 : displayIdx + 1;
        groupInp.max = displayTotal > 0 ? displayTotal : 1;
        groupInp.min = displayTotal > 0 ? 1 : 0;
        groupCountEl.innerText = `/ ${displayTotal}`;
        delBtn.disabled = totalGroups === 0 || !admin || edit; // ×”×©×‘×ª×” ×’× ×‘××¦×‘ ×¢×¨×™×›×”
        newBtn.disabled = edit; // ×”×©×‘×ª×ª ×›×¤×ª×•×¨ ×”×•×¡×¤×” ×‘×–××Ÿ ×¢×¨×™×›×”
        importBtn.disabled = edit; // ×”×©×‘×ª×ª ×›×¤×ª×•×¨ ×™×™×‘×•× ×‘×–××Ÿ ×¢×¨×™×›×”
      }

      prevBtn.onclick = () => {
        if (idx > 0 && !edit) {
          idx--;
          render();
          updateNav();
        }
      };
      nextBtn.onclick = () => {
        if (idx < groups.length - 1 && !edit) {
          idx++;
          render();
          updateNav();
        }
      };
      groupInp.onchange = (e) => {
        if (edit) return; // ×œ× ×××¤×©×¨×™× ×©×™× ×•×™ ×‘×–××Ÿ ×¢×¨×™×›×”
        const v = +e.target.value - 1;
        if (v >= 0 && v < groups.length) {
          idx = v;
          render();
          updateNav();
        } else {
          e.target.value = idx + 1;
        } // ×”×—×–×¨ ×œ×¢×¨×š ×”×§×•×“× ×× ×œ× ×ª×§×™×Ÿ
      };

      // --- Edit Form Event Listeners ---
      container.addEventListener("click", (e) => {
        // Edit button
        if (e.target.id === "editBtn") {
          if (!admin || edit) return; // ×× ×™×¢×” ×× ×œ× ××“××™×Ÿ ××• ×›×‘×¨ ×‘×¢×¨×™×›×”
          // const targetIdx = parseInt(e.target.getAttribute('data-idx'), 10); // ×§×‘×œ×ª ×”××™× ×“×§×¡ ××”×›×¤×ª×•×¨
          // if (!isNaN(targetIdx) && targetIdx < groups.length) {
          //     idx = targetIdx; // ×•×“× ×©×× ×—× ×• ×¢×•×¨×›×™× ××ª ×”××™× ×“×§×¡ ×”× ×›×•×Ÿ
          edit = true;
          isAddingNewGroup = false; // ××•×•×“××™× ×©×× ×—× ×• ×œ× ×‘××¦×‘ ×”×•×¡×¤×”
          render();
          updateNav(); // ×”×©×‘×ª×ª × ×™×•×•×˜ ×•×›×•'
          // }
          return;
        }
        // Cancel button
        if (e.target.id === "cancelBtn") {
          const wasAdding = isAddingNewGroup; // ×©××™×¨×ª ×”××¦×‘ ×œ×¤× ×™ ×”××™×¤×•×¡
          edit = false;
          isAddingNewGroup = false;
          newGroupDataBuffer = null;
          statusEl.innerText = wasAdding ? "×”×•×¡×¤×ª ×§×‘×•×¦×” ×‘×•×˜×œ×”" : "×¢×¨×™×›×” ×‘×•×˜×œ×”";
          // ×× ×‘×™×˜×œ× ×• ×”×•×¡×¤×” ×©×œ ×§×‘×•×¦×” ×¨××©×•× ×”, idx ×¦×¨×™×š ×œ×”×™×•×ª 0 ××‘×œ groups ×¢×“×™×™×Ÿ ×¨×™×§
          if (wasAdding && groups.length === 0) {
            idx = 0;
          } else if (wasAdding) {
            // ×× ×‘×™×˜×œ× ×• ×”×•×¡×¤×”, × ×—×–×•×¨ ×œ××™× ×“×§×¡ ×”××—×¨×•×Ÿ ×©×”×™×” ×§×™×™×
            idx = Math.max(0, groups.length - 1);
          }
          // ×× ×‘×™×˜×œ× ×• ×¢×¨×™×›×” ×¨×’×™×œ×”, idx × ×©××¨ ×›×¤×™ ×©×”×™×”
          render();
          updateNav();
          return;
        }
        // Add Sentence button
        if (e.target.id === "addSentence") {
          const sentencesContainer = document.getElementById(
            "sentences-container"
          );
          if (sentencesContainer) {
            const newRowDiv = document.createElement("div");
            newRowDiv.innerHTML = rowHTML("", false); // ×”×•×¡×¤×ª ×©×•×¨×” ×¨×™×§×”
            const newRowElement = newRowDiv.firstElementChild;
            if (newRowElement) {
              sentencesContainer.appendChild(newRowElement);
              const firstInput =
                newRowElement.querySelector('input[type="text"]');
              if (firstInput) firstInput.focus(); // ×¤×•×§×•×¡ ×¢×œ ×”×©×“×” ×”×—×“×©
            }
          }
          return;
        }
        // Remove Sentence button
        if (e.target.classList.contains("removeSentence")) {
          const row = e.target.closest(".sentence-row");
          const container = row?.closest("#sentences-container");
          if (row) {
            // ×× ×™×¢×ª ××—×™×§×ª ×©×•×¨×” ××—×¨×•× ×”
            if (
              container &&
              container.querySelectorAll(".sentence-row").length <= 1
            ) {
              statusEl.innerText = "×—×•×‘×” ×œ×”×©××™×¨ ×œ×¤×—×•×ª ××©×¤×˜ ××—×“.";
              // ××¤×©×¨ ×œ×”×•×¡×™×£ ×”×“×’×©×” ×œ×©×•×¨×” ××• ××©×”×• ×•×™×–×•××œ×™
              row.animate(
                [
                  { backgroundColor: "rgba(255,0,0,0.2)" },
                  { backgroundColor: "transparent" },
                ],
                { duration: 500 }
              );
              return;
            }
            row.remove();
          }
          return;
        }
      });

      container.addEventListener("submit", (e) => {
        e.preventDefault();
        if (!admin || !edit) return; // ×¨×§ ×× ××“××™×Ÿ ×•×‘××¦×‘ ×¢×¨×™×›×”
        const form = e.target;
        if (form.id !== "editForm") return;

        statusEl.innerText = "×©×•××¨...";

        const diffInput = document.getElementById("diffInput");
        const topicInput = document.getElementById("topicInput");
        const difficulty = diffInput ? parseInt(diffInput.value) || 1 : 1;
        const topic = topicInput ? topicInput.value : "×›×œ×œ×™";

        const rows = [...form.querySelectorAll(".sentence-row")];
        let errorOccurred = false;
        const sentences = rows
          .map((row) => {
            const textInput = row.querySelector(".sentence-input");
            const lockCheckbox = row.querySelector(".lock-checkbox");

            if (!textInput || !lockCheckbox) {
              console.error("Malformed sentence row found:", row);
              statusEl.innerText = "×©×’×™××”: ××‘× ×” ×©×•×¨×” ×œ× ×ª×§×™×Ÿ. ×œ× × ×™×ª×Ÿ ×œ×©××•×¨.";
              errorOccurred = true;
              return null;
            }
            const textValue = textInput.value.trim();
            // ×××¤×©×¨×™× ×©××™×¨×ª ××©×¤×˜×™× ×¨×™×§×™× ×›×“×™ ×œ× ×œ××‘×“ ××™×“×¢ ×‘×–××Ÿ ×¢×¨×™×›×”,
            // ××‘×œ ××¡× × ×™× ××•×ª× ×œ×¤× ×™ ×”×©××™×¨×” ×”×¡×•×¤×™×ª ×× ×¨×•×¦×™×
            if (!textValue) {
              // ××¤×©×¨ ×œ×‘×—×•×¨ ×× ×œ×”×ª×¢×œ× ××• ×œ×”×—×–×™×¨ ×©×’×™××”
              console.warn("Empty sentence found, skipping row:", row);
              return null; // ×”×ª×¢×œ××•×ª ×××©×¤×˜×™× ×¨×™×§×™×
              /*
             statusEl.innerText = '×©×’×™××”: ×œ× × ×™×ª×Ÿ ×œ×©××•×¨ ××©×¤×˜ ×¨×™×§.';
             errorOccurred = true;
             return null; // ×¢×¦×™×¨×ª ×”×©××™×¨×”
             */
            }
            return {
              text: textValue,
              movable: !lockCheckbox.checked,
            };
          })
          .filter((s) => s !== null); // ×¡×™× ×•×Ÿ ××©×¤×˜×™× ×¨×™×§×™× (nulls)

        if (errorOccurred) return;

        if (sentences.length === 0) {
          statusEl.innerText = "×©×’×™××”: ×™×© ×œ×”×–×™×Ÿ ×œ×¤×—×•×ª ××©×¤×˜ ××—×“ ×ª×§×™×Ÿ.";
          return;
        }

        const finalGroupData = { difficulty, topic, sentences };
        const wasAdding = isAddingNewGroup; // ×‘×“×™×§×” ×× ×”×™×™× ×• ×‘××¦×‘ ×”×•×¡×¤×”

        // *** ×©×™× ×•×™: ×”×—×œ×˜×” ×× ×œ×¢×“×›×Ÿ ××• ×œ×”×•×¡×™×£ ***
        let savePromise;
        let newIndex = groups.length; // ×”××™× ×“×§×¡ ×”×—×“×© ×× ×–×• ×”×•×¡×¤×”

        if (wasAdding) {
          // ×”×•×¡×¤×ª ×§×‘×•×¦×” ×—×“×©×” ×‘×¡×•×£ ×”××¢×¨×š
          savePromise = set(
            ref(db, `collections/groups/${newIndex}`),
            finalGroupData
          );
        } else {
          // ×¢×“×›×•×Ÿ ×§×‘×•×¦×” ×§×™×™××ª ×‘××™× ×“×§×¡ ×”× ×•×›×—×™ (idx)
          savePromise = update(
            ref(db, `collections/groups/${idx}`),
            finalGroupData
          );
        }

        savePromise
          .then(() => {
            statusEl.innerText = wasAdding
              ? "×§×‘×•×¦×” ×—×“×©×” × ×©××¨×” ×‘×”×¦×œ×—×”"
              : "× ×©××¨ ×‘×”×¦×œ×—×”";
            edit = false;
            isAddingNewGroup = false;
            newGroupDataBuffer = null;
            // ×× ×”×•×¡×¤× ×•, × ×¢×‘×•×¨ ×œ×”×¦×™×’ ××ª ×”×§×‘×•×¦×” ×”×—×“×©×” ×©× ×•×¡×¤×”
            if (wasAdding) {
              idx = newIndex; // ×¢×“×›×•×Ÿ ×”××™× ×“×§×¡ ×”×¤×¢×™×œ ×œ××™× ×“×§×¡ ×”×—×“×©
              // ×”-listener ×™×˜×¢×Ÿ ××ª ×”× ×ª×•× ×™× ××—×“×© ×•×™×¤×¢×™×œ render ×•-updateNav
            } else {
              // ×× ×¢×“×›× ×•, ×”-listener ×™×˜×¤×œ ×‘×¢×“×›×•×Ÿ ×”×ª×¦×•×’×”
              render(); // ××¤×©×¨ ×œ×¨× ×“×¨ ××™×“ ×œ××¦×‘ ×ª×¦×•×’×”
              updateNav();
            }
            // ×”-Listener ×©×œ Firebase ×™×‘×˜×™×— ×©×”×ª×¦×•×’×” ×ª×ª×¢×“×›×Ÿ ×¡×•×¤×™×ª ×¢× ×”× ×ª×•× ×™× ××”×©×¨×ª
          })
          .catch((e) => {
            console.error("Save error:", e);
            statusEl.innerText = "×©×’×™××” ×‘×©××™×¨×”: " + e.message;
            // ××©××™×¨×™× ×‘××¦×‘ ×¢×¨×™×›×” ×›×“×™ ×©×”××©×ª××© ×™×•×›×œ ×œ×ª×§×Ÿ ×•×œ× ×¡×•×ª ×©×•×‘
          });
      });
    </script>
  </body>
</html>
